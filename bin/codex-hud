#!/usr/bin/env bash
#
# codex-hud - Wrapper script for Codex CLI with HUD display
# Launches Codex in a tmux session with a status bar pane
#
# Environment variables:
#   CODEX_HUD_POSITION - HUD pane position: bottom (default), top
#   CODEX_HUD_HEIGHT   - HUD pane height in lines (default: 1/6 of terminal height, min 5)
#   CODEX_HUD_NO_ATTACH - If set, don't attach to existing session
#   CODEX_HUD_CLEAR_SCROLLBACK - If set to 1, clears tmux scrollback on first render
#

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HUD_DIR="$(dirname "$SCRIPT_DIR")"
HUD_HEIGHT="${CODEX_HUD_HEIGHT:-}"
HUD_POSITION="${CODEX_HUD_POSITION:-bottom}"
ALIAS_MARKER="# codex-hud alias"
CODEX_CLI_PATH=""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print error message and exit
error() {
    echo -e "${RED}Error:${NC} $1" >&2
    exit 1
}

# Print warning message
warn() {
    echo -e "${YELLOW}Warning:${NC} $1" >&2
}

# Print info message
info() {
    echo -e "${GREEN}Info:${NC} $1"
}

# Print step message
step() {
    echo -e "${BLUE}==>${NC} $1"
}

# Check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

hash_cwd() {
    local cwd="$1"
    local hash=""
    if command_exists md5sum; then
        hash=$(printf "%s" "$cwd" | md5sum | awk '{print $1}')
    elif command_exists md5; then
        hash=$(printf "%s" "$cwd" | md5 -q 2>/dev/null || printf "%s" "$cwd" | md5 | awk '{print $NF}')
    elif command_exists shasum; then
        hash=$(printf "%s" "$cwd" | shasum -a 256 | awk '{print $1}')
    fi
    if [[ -n "$hash" ]]; then
        echo "${hash:0:8}"
    else
        echo "$$"
    fi
}

# Generate session name based on PWD hash (unique per invocation)
SESSION_HASH="$(hash_cwd "$PWD")"
SESSION_PREFIX="codex-hud-${SESSION_HASH}"
SESSION_NAME="${SESSION_PREFIX}-$(date +%Y%m%d%H%M%S)-$$"

resolve_codex_cli() {
    local path
    path=$(command -v codex 2>/dev/null || true)
    if [[ -z "$path" ]]; then
        error "codex CLI is not found in PATH.

Install Codex CLI from: https://github.com/openai/codex"
    fi
    if [[ "$path" == "$SCRIPT_DIR/codex-hud" ]]; then
        error "codex resolves to codex-hud wrapper. Fix your alias to point to the real codex CLI."
    fi
    CODEX_CLI_PATH="$path"
}

# Get zsh rc file location (respects ZDOTDIR when set)
get_zsh_rc_file() {
    if [[ -n "${ZDOTDIR:-}" ]]; then
        echo "$ZDOTDIR/.zshrc"
        return 0
    fi
    echo "$HOME/.zshrc"
}

# Get the RC file for the current shell
get_shell_rc_file() {
    local shell_name
    shell_name=$(basename "$SHELL")
    case "$shell_name" in
        bash)
            if [[ -f "$HOME/.bashrc" ]]; then
                echo "$HOME/.bashrc"
            elif [[ -f "$HOME/.bash_profile" ]]; then
                echo "$HOME/.bash_profile"
            else
                echo "$HOME/.bashrc"
            fi
            ;;
        zsh)
            get_zsh_rc_file
            ;;
        fish)
            echo "$HOME/.config/fish/config.fish"
            ;;
        *)
            echo ""
            ;;
    esac
}

# Detect OS and package manager
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ -f /etc/debian_version ]]; then
        echo "debian"
    elif [[ -f /etc/redhat-release ]]; then
        echo "redhat"
    elif [[ -f /etc/arch-release ]]; then
        echo "arch"
    elif [[ -f /etc/alpine-release ]]; then
        echo "alpine"
    else
        echo "unknown"
    fi
}

# Install tmux automatically
install_tmux() {
    local os
    os=$(detect_os)
    
    step "Installing tmux..."
    
    case "$os" in
        macos)
            if command_exists brew; then
                brew install tmux
            else
                error "Homebrew not found. Please install Homebrew first: https://brew.sh"
            fi
            ;;
        debian)
            if command_exists sudo; then
                sudo apt-get update && sudo apt-get install -y tmux
            else
                apt-get update && apt-get install -y tmux
            fi
            ;;
        redhat)
            if command_exists sudo; then
                sudo yum install -y tmux || sudo dnf install -y tmux
            else
                yum install -y tmux || dnf install -y tmux
            fi
            ;;
        arch)
            if command_exists sudo; then
                sudo pacman -S --noconfirm tmux
            else
                pacman -S --noconfirm tmux
            fi
            ;;
        alpine)
            if command_exists sudo; then
                sudo apk add tmux
            else
                apk add tmux
            fi
            ;;
        *)
            error "Could not detect OS for automatic tmux installation.

Please install tmux manually:
  Linux (Debian/Ubuntu): sudo apt install tmux
  Linux (RHEL/CentOS):   sudo yum install tmux
  Linux (Arch):          sudo pacman -S tmux
  macOS:                 brew install tmux"
            ;;
    esac
    
    # Verify installation
    if command_exists tmux; then
        info "tmux installed successfully!"
    else
        error "tmux installation failed. Please install manually."
    fi
}

# Check dependencies (with auto-install for tmux)
check_dependencies() {
    # Check tmux - auto-install if missing
    if ! command_exists tmux; then
        warn "tmux is not installed."
        echo ""
        read -p "Would you like to install tmux automatically? [Y/n] " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
            install_tmux
        else
            error "tmux is required for codex-hud. Please install it manually."
        fi
    fi
    
    resolve_codex_cli
    
    if ! command_exists node; then
        error "Node.js is required but not installed.

Install Node.js 18+ from: https://nodejs.org/"
    fi
}

# Build the HUD renderer if needed
build_hud() {
    local dist_file="$HUD_DIR/dist/index.js"
    local src_file="$HUD_DIR/src/index.ts"
    
    # Check if node_modules exists
    if [[ ! -d "$HUD_DIR/node_modules" ]]; then
        step "Installing dependencies..."
        (cd "$HUD_DIR" && npm install) || error "Failed to install dependencies"
    fi
    
    # Check if we need to build
    if [[ ! -f "$dist_file" ]] || [[ "$src_file" -nt "$dist_file" ]]; then
        step "Building HUD renderer..."
        (cd "$HUD_DIR" && npm run build) || error "Failed to build HUD renderer"
    fi
}

# Get the current working directory for Codex
get_cwd() {
    pwd
}

# Get the first pane ID in the session
get_primary_pane_id() {
    tmux list-panes -t "$SESSION_NAME" -F "#{pane_id}" 2>/dev/null | head -n1
}

# Find the most recent existing session for this directory
find_existing_session() {
    tmux list-sessions -F "#{session_name}" 2>/dev/null | grep "^${SESSION_PREFIX}-" | sort | tail -n1
}

set_fixed_hud_height() {
    local session_name="$1"
    local hud_pane_id="$2"
    local height="$3"
    local resize_helper="$SCRIPT_DIR/codex-hud-resize"

    if [[ -z "$session_name" || -z "$hud_pane_id" || -z "$height" ]]; then
        return 0
    fi

    local auto_setting
    local min_setting
    local max_setting

    auto_setting="${CODEX_HUD_HEIGHT_AUTO:-}"
    if [[ -z "$auto_setting" ]]; then
        auto_setting=$(tmux show-option -t "$session_name" -qv @codex_hud_auto)
    fi
    if [[ -z "$auto_setting" ]]; then
        auto_setting="1"
    fi

    min_setting="${CODEX_HUD_HEIGHT_MIN:-}"
    if [[ -z "$min_setting" ]]; then
        min_setting=$(tmux show-option -t "$session_name" -qv @codex_hud_height_min)
    fi
    if [[ -z "$min_setting" ]]; then
        min_setting="$height"
    fi

    max_setting="${CODEX_HUD_HEIGHT_MAX:-}"
    if [[ -z "$max_setting" ]]; then
        max_setting=$(tmux show-option -t "$session_name" -qv @codex_hud_height_max)
    fi
    if [[ -z "$max_setting" ]]; then
        max_setting="12"
    fi

    tmux set-option -t "$session_name" -q @codex_hud_pane "$hud_pane_id"
    tmux set-option -t "$session_name" -q @codex_hud_auto "$auto_setting"
    tmux set-option -t "$session_name" -q @codex_hud_height_min "$min_setting"
    tmux set-option -t "$session_name" -q @codex_hud_height_max "$max_setting"
    tmux set-option -t "$session_name" -q @codex_hud_base_height "$height"
    tmux set-option -t "$session_name" -q @codex_hud_height "$height"

    if [[ -x "$resize_helper" ]]; then
        "$resize_helper" "$session_name"
    else
        tmux resize-pane -t "$hud_pane_id" -y "$height" 2>/dev/null || true
    fi

    local hook_cmd
    if [[ -x "$resize_helper" ]]; then
        hook_cmd="run-shell \"$resize_helper #{session_name}\""
        tmux set-hook -t "$session_name" client-resized "$hook_cmd"
        tmux set-hook -t "$session_name" after-resize-pane "$hook_cmd"
    fi
}

# Check if session already exists and is usable
check_existing_session() {
    if [[ -n "${CODEX_HUD_NO_ATTACH:-}" ]]; then
        return 1
    fi
    
    local existing
    existing=$(find_existing_session)
    if [[ -n "$existing" ]]; then
        SESSION_NAME="$existing"
        return 0
    fi
    return 1
}

# Cleanup function - only cleanup on explicit exit, not on attach to existing
cleanup() {
    # Only kill session if we created it (not if we attached to existing)
    if [[ "${SESSION_CREATED:-}" == "true" ]]; then
        if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
            tmux kill-session -t "$SESSION_NAME" 2>/dev/null || true
        fi
    fi
}

# Resolve HUD height based on terminal size
resolve_hud_height() {
    local term_height="$1"
    local requested="$HUD_HEIGHT"
    local min_height=5
    local max_height=$((term_height - 1))
    if [[ "$max_height" -lt 1 ]]; then
        max_height=1
    fi
    
    if [[ -n "$requested" ]]; then
        if ! [[ "$requested" =~ ^[0-9]+$ ]]; then
            error "CODEX_HUD_HEIGHT must be a positive integer (got: $requested)"
        fi
        if [[ "$requested" -gt "$max_height" ]]; then
            HUD_HEIGHT="$max_height"
            return 0
        fi
        if [[ "$requested" -lt 1 ]]; then
            HUD_HEIGHT="1"
            return 0
        fi
        HUD_HEIGHT="$requested"
        return 0
    fi
    
    local desired=$((term_height / 6))
    if [[ "$desired" -lt "$min_height" ]]; then
        desired="$min_height"
    fi
    if [[ "$desired" -gt "$max_height" ]]; then
        desired="$max_height"
    fi
    if [[ "$desired" -lt 1 ]]; then
        desired="1"
    fi
    HUD_HEIGHT="$desired"
}

# Create new tmux session with HUD
create_session() {
    local cwd="$1"
    shift
    local codex_args=("$@")
    local cwd_escaped
    cwd_escaped=$(printf "%q" "$cwd")
    
    # Calculate terminal dimensions
    local term_height
    local term_width
    term_height=$(tput lines 2>/dev/null || echo 24)
    term_width=$(tput cols 2>/dev/null || echo 80)
    resolve_hud_height "$term_height"
    
    # Build the codex command string
    local codex_cmd="$CODEX_CLI_PATH"
    for arg in "${codex_args[@]}"; do
        codex_cmd="$codex_cmd $(printf "%q" "$arg")"
    done
    
    # Create new detached session
    tmux new-session -d -s "$SESSION_NAME" -x "$term_width" -y "$term_height"
    # Optimize tmux mouse + scroll behavior for smoother trackpad scrolling
    tmux set-option -t "$SESSION_NAME" mouse on
    tmux set-option -t "$SESSION_NAME" escape-time 0
    tmux set-option -t "$SESSION_NAME" assume-paste-time 0
    tmux set-option -t "$SESSION_NAME" repeat-time 0
    tmux set-option -t "$SESSION_NAME" history-limit 200000
    tmux set-option -t "$SESSION_NAME" wheel-scroll-lines 1 2>/dev/null || true
    local main_pane_id
    main_pane_id=$(get_primary_pane_id)
    if [[ -z "$main_pane_id" ]]; then
        error "Failed to detect tmux pane for session: $SESSION_NAME"
    fi
    
    # Send the codex command to the main pane; auto-cleanup when it exits
    tmux send-keys -t "$SESSION_NAME" "cd ${cwd_escaped} && $codex_cmd; tmux kill-session -t '$SESSION_NAME'" C-m
    
    # Wait a moment for the session to be ready
    sleep 0.2
    
    # Split the window based on HUD_POSITION
    local session_start
    session_start=$(date +%s)
    local hud_cmd="cd ${cwd_escaped} && LINES='$HUD_HEIGHT' COLUMNS='$term_width' CODEX_HUD_CWD=${cwd_escaped} CODEX_HUD_SESSION_START='$session_start' CODEX_HUD_TMUX_SESSION='$SESSION_NAME' CODEX_HUD_CLEAR_SCROLLBACK='${CODEX_HUD_CLEAR_SCROLLBACK:-}' node '$HUD_DIR/dist/index.js'"
    
    if [[ "$HUD_POSITION" == "top" ]]; then
        # Split at top, then swap panes
        local hud_pane_id
        hud_pane_id=$(tmux split-window -v -t "$SESSION_NAME" -l "$HUD_HEIGHT" -b -P -F "#{pane_id}" "$hud_cmd")
        tmux select-pane -t "$main_pane_id"
    else
        # Default: bottom
        local hud_pane_id
        hud_pane_id=$(tmux split-window -v -t "$SESSION_NAME" -l "$HUD_HEIGHT" -P -F "#{pane_id}" "$hud_cmd")
        tmux select-pane -t "$main_pane_id"
    fi

    if [[ -n "${hud_pane_id:-}" ]]; then
        set_fixed_hud_height "$SESSION_NAME" "$hud_pane_id" "$HUD_HEIGHT"
    fi

    # Bind toggle key (Prefix + H) to switch HUD modes for this session
    tmux bind-key -T prefix H run-shell "tmux if-shell -F '#{@codex_hud_pane}' 'tmux send-keys -t #{@codex_hud_pane} C-t' ''"
    
    SESSION_CREATED="true"
}

# Main function
main() {
    # Parse arguments
    local codex_args=("$@")
    
    # Check dependencies
    check_dependencies
    
    # Build HUD if needed
    build_hud
    
    # Get current working directory
    local cwd
    cwd=$(get_cwd)
    
    # Check for existing session
    if check_existing_session; then
        info "Attaching to existing session: $SESSION_NAME"
        local main_pane_id
        main_pane_id=$(get_primary_pane_id)
        if [[ -n "$main_pane_id" ]]; then
            tmux select-pane -t "$main_pane_id" 2>/dev/null || true
        fi
        local hud_pane_id
        hud_pane_id=$(tmux show-option -t "$SESSION_NAME" -qv @codex_hud_pane)
        if [[ -n "$hud_pane_id" ]]; then
            set_fixed_hud_height "$SESSION_NAME" "$hud_pane_id" "$HUD_HEIGHT"
        fi
        tmux attach-session -t "$SESSION_NAME"
        return 0
    fi
    
    # Set up cleanup trap
    trap cleanup EXIT
    
    # Create new session
    info "Starting Codex with HUD (session: $SESSION_NAME)..."
    create_session "$cwd" "${codex_args[@]}"
    
    # Attach to the session
    local main_pane_id
    main_pane_id=$(get_primary_pane_id)
    if [[ -n "$main_pane_id" ]]; then
        tmux select-pane -t "$main_pane_id" 2>/dev/null || true
    fi
    tmux attach-session -t "$SESSION_NAME"
}

# Show help
show_help() {
    cat << EOF
codex-hud - Codex CLI with HUD display

Usage: codex-hud [options] [codex options...]

This wrapper launches Codex in a tmux session with a real-time status bar
showing model info, git status, project info, token usage, and more.

All arguments are passed through to the codex command.

Options:
  -h, --help          Show this help message
  --self-check        Run environment diagnostics
  --kill              Kill existing session for current directory
  --list              List all codex-hud sessions

Environment Variables:
  CODEX_HUD_POSITION  HUD pane position: bottom (default), top
  CODEX_HUD_HEIGHT    HUD pane height in lines (default: 1/6 of terminal height, min 5)
  CODEX_HUD_NO_ATTACH If set, always create new session

Requirements:
  - tmux (auto-installed if missing)
  - Node.js 18+
  - Codex CLI

Examples:
  codex-hud                    Start Codex with HUD
  codex-hud --model gpt-5      Start with specific model
  codex-hud "help me debug"    Start with initial prompt
  codex-hud --kill             Kill existing session
  CODEX_HUD_POSITION=top codex-hud  HUD on top

For more information, see: https://github.com/openai/codex
EOF
}

# Run environment diagnostics
self_check() {
    local failures=0
    
    echo "Codex HUD self-check"
    echo ""
    
    if [[ -n "${ZDOTDIR:-}" ]] && [[ ! -d "$ZDOTDIR" ]]; then
        warn "ZDOTDIR is set but does not exist: $ZDOTDIR"
        failures=$((failures + 1))
    fi
    
    local codex_path
    codex_path=$(command -v codex 2>/dev/null || true)
    if [[ -n "$codex_path" ]]; then
        info "codex: $codex_path"
        if [[ "$codex_path" == "$SCRIPT_DIR/codex-hud" ]]; then
            warn "codex resolves to codex-hud wrapper; fix alias to the real codex CLI."
            failures=$((failures + 1))
        fi
    else
        warn "codex CLI not found in PATH"
        failures=$((failures + 1))
    fi
    
    if command_exists node; then
        info "node $(node --version)"
    else
        warn "node not found in PATH"
        failures=$((failures + 1))
    fi
    
    if command_exists tmux; then
        info "tmux $(tmux -V)"
        local pane_index
        pane_index=$(tmux show-options -gqv pane-base-index)
        if [[ -n "$pane_index" && "$pane_index" != "0" ]]; then
            info "tmux pane-base-index=$pane_index (supported)"
        fi
    else
        warn "tmux not found in PATH"
        failures=$((failures + 1))
    fi
    
    local rc_file
    rc_file=$(get_shell_rc_file)
    if [[ -z "$rc_file" ]]; then
        warn "Unable to determine shell rc file for: $SHELL"
        failures=$((failures + 1))
    elif [[ ! -f "$rc_file" ]]; then
        warn "RC file not found: $rc_file"
        failures=$((failures + 1))
    elif grep -q "$ALIAS_MARKER" "$rc_file" 2>/dev/null; then
        info "Alias marker found in $rc_file"
    else
        warn "Alias marker not found in $rc_file"
        failures=$((failures + 1))
    fi
    
    if [[ ! -f "$HUD_DIR/dist/index.js" ]]; then
        warn "HUD build output not found: $HUD_DIR/dist/index.js"
    fi
    
    if [[ "$failures" -gt 0 ]]; then
        warn "Self-check found $failures issue(s)."
        exit 1
    fi
    
    info "Self-check passed."
}

# Kill existing session
kill_session() {
    local sessions
    sessions=$(tmux list-sessions -F "#{session_name}" 2>/dev/null | grep "^${SESSION_PREFIX}" || true)
    if [[ -z "$sessions" ]]; then
        warn "No session found: $SESSION_PREFIX"
        return
    fi
    while IFS= read -r session_name; do
        if [[ -n "$session_name" ]]; then
            tmux kill-session -t "$session_name"
        fi
    done <<< "$sessions"
    info "Session(s) '$SESSION_PREFIX' killed."
}

# List all codex-hud sessions
list_sessions() {
    echo "Active codex-hud sessions:"
    tmux list-sessions 2>/dev/null | grep "^codex-hud-" || echo "  (none)"
}

# Check for special flags first
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    --self-check)
        self_check
        exit 0
        ;;
    --kill)
        # Need to check dependencies to ensure tmux is available
        if command_exists tmux; then
            kill_session
        else
            error "tmux not installed"
        fi
        exit 0
        ;;
    --list)
        if command_exists tmux; then
            list_sessions
        else
            error "tmux not installed"
        fi
        exit 0
        ;;
esac

# Run main
main "$@"
