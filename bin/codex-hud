#!/usr/bin/env bash
#
# codex-hud - Wrapper script for Codex CLI with HUD display
# Launches Codex in a tmux session with a status bar pane
#
# Environment variables:
#   CODEX_HUD_POSITION - HUD pane position: bottom (default), top
#   CODEX_HUD_HEIGHT   - HUD pane height in lines (default: 3)
#   CODEX_HUD_NO_ATTACH - If set, don't attach to existing session
#

set -e

# Configuration
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HUD_DIR="$(dirname "$SCRIPT_DIR")"
HUD_HEIGHT="${CODEX_HUD_HEIGHT:-3}"
HUD_POSITION="${CODEX_HUD_POSITION:-bottom}"

# Generate session name based on PWD hash (allows session reuse per directory)
SESSION_NAME="codex-hud-$(echo "$PWD" | md5sum 2>/dev/null | cut -c1-8 || echo "$$")"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Print error message and exit
error() {
    echo -e "${RED}Error:${NC} $1" >&2
    exit 1
}

# Print warning message
warn() {
    echo -e "${YELLOW}Warning:${NC} $1" >&2
}

# Print info message
info() {
    echo -e "${GREEN}Info:${NC} $1"
}

# Print step message
step() {
    echo -e "${BLUE}==>${NC} $1"
}

# Check if a command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Detect OS and package manager
detect_os() {
    if [[ "$OSTYPE" == "darwin"* ]]; then
        echo "macos"
    elif [[ -f /etc/debian_version ]]; then
        echo "debian"
    elif [[ -f /etc/redhat-release ]]; then
        echo "redhat"
    elif [[ -f /etc/arch-release ]]; then
        echo "arch"
    elif [[ -f /etc/alpine-release ]]; then
        echo "alpine"
    else
        echo "unknown"
    fi
}

# Install tmux automatically
install_tmux() {
    local os
    os=$(detect_os)
    
    step "Installing tmux..."
    
    case "$os" in
        macos)
            if command_exists brew; then
                brew install tmux
            else
                error "Homebrew not found. Please install Homebrew first: https://brew.sh"
            fi
            ;;
        debian)
            if command_exists sudo; then
                sudo apt-get update && sudo apt-get install -y tmux
            else
                apt-get update && apt-get install -y tmux
            fi
            ;;
        redhat)
            if command_exists sudo; then
                sudo yum install -y tmux || sudo dnf install -y tmux
            else
                yum install -y tmux || dnf install -y tmux
            fi
            ;;
        arch)
            if command_exists sudo; then
                sudo pacman -S --noconfirm tmux
            else
                pacman -S --noconfirm tmux
            fi
            ;;
        alpine)
            if command_exists sudo; then
                sudo apk add tmux
            else
                apk add tmux
            fi
            ;;
        *)
            error "Could not detect OS for automatic tmux installation.

Please install tmux manually:
  Linux (Debian/Ubuntu): sudo apt install tmux
  Linux (RHEL/CentOS):   sudo yum install tmux
  Linux (Arch):          sudo pacman -S tmux
  macOS:                 brew install tmux"
            ;;
    esac
    
    # Verify installation
    if command_exists tmux; then
        info "tmux installed successfully!"
    else
        error "tmux installation failed. Please install manually."
    fi
}

# Check dependencies (with auto-install for tmux)
check_dependencies() {
    # Check tmux - auto-install if missing
    if ! command_exists tmux; then
        warn "tmux is not installed."
        echo ""
        read -p "Would you like to install tmux automatically? [Y/n] " -n 1 -r
        echo ""
        if [[ $REPLY =~ ^[Yy]$ ]] || [[ -z $REPLY ]]; then
            install_tmux
        else
            error "tmux is required for codex-hud. Please install it manually."
        fi
    fi
    
    if ! command_exists codex; then
        error "codex CLI is not found in PATH.

Install Codex CLI from: https://github.com/openai/codex"
    fi
    
    if ! command_exists node; then
        error "Node.js is required but not installed.

Install Node.js 18+ from: https://nodejs.org/"
    fi
}

# Build the HUD renderer if needed
build_hud() {
    local dist_file="$HUD_DIR/dist/index.js"
    local src_file="$HUD_DIR/src/index.ts"
    
    # Check if node_modules exists
    if [[ ! -d "$HUD_DIR/node_modules" ]]; then
        step "Installing dependencies..."
        (cd "$HUD_DIR" && npm install) || error "Failed to install dependencies"
    fi
    
    # Check if we need to build
    if [[ ! -f "$dist_file" ]] || [[ "$src_file" -nt "$dist_file" ]]; then
        step "Building HUD renderer..."
        (cd "$HUD_DIR" && npm run build) || error "Failed to build HUD renderer"
    fi
}

# Get the current working directory for Codex
get_cwd() {
    pwd
}

# Check if session already exists and is usable
check_existing_session() {
    if [[ -n "${CODEX_HUD_NO_ATTACH:-}" ]]; then
        return 1
    fi
    
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        return 0
    fi
    return 1
}

# Cleanup function - only cleanup on explicit exit, not on attach to existing
cleanup() {
    # Only kill session if we created it (not if we attached to existing)
    if [[ "${SESSION_CREATED:-}" == "true" ]]; then
        if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
            tmux kill-session -t "$SESSION_NAME" 2>/dev/null || true
        fi
    fi
}

# Create new tmux session with HUD
create_session() {
    local cwd="$1"
    shift
    local codex_args=("$@")
    
    # Calculate terminal dimensions
    local term_height
    local term_width
    term_height=$(tput lines 2>/dev/null || echo 24)
    term_width=$(tput cols 2>/dev/null || echo 80)
    
    # Build the codex command string
    local codex_cmd="codex"
    if [[ ${#codex_args[@]} -gt 0 ]]; then
        # Properly quote arguments
        codex_cmd="codex"
        for arg in "${codex_args[@]}"; do
            codex_cmd="$codex_cmd '$arg'"
        done
    fi
    
    # Create new detached session
    tmux new-session -d -s "$SESSION_NAME" -x "$term_width" -y "$term_height"
    
    # Send the codex command to the main pane
    tmux send-keys -t "$SESSION_NAME" "cd '$cwd' && $codex_cmd" C-m
    
    # Wait a moment for the session to be ready
    sleep 0.2
    
    # Split the window based on HUD_POSITION
    local hud_cmd="cd '$cwd' && CODEX_HUD_CWD='$cwd' node '$HUD_DIR/dist/index.js'"
    
    if [[ "$HUD_POSITION" == "top" ]]; then
        # Split at top, then swap panes
        tmux split-window -v -t "$SESSION_NAME" -l "$HUD_HEIGHT" -b "$hud_cmd"
        tmux select-pane -t "$SESSION_NAME:.2"
    else
        # Default: bottom
        tmux split-window -v -t "$SESSION_NAME" -l "$HUD_HEIGHT" "$hud_cmd"
        tmux select-pane -t "$SESSION_NAME:.1"
    fi
    
    SESSION_CREATED="true"
}

# Main function
main() {
    # Parse arguments
    local codex_args=("$@")
    
    # Check dependencies
    check_dependencies
    
    # Build HUD if needed
    build_hud
    
    # Get current working directory
    local cwd
    cwd=$(get_cwd)
    
    # Check for existing session
    if check_existing_session; then
        info "Attaching to existing session: $SESSION_NAME"
        tmux attach-session -t "$SESSION_NAME"
        return 0
    fi
    
    # Set up cleanup trap
    trap cleanup EXIT
    
    # Create new session
    info "Starting Codex with HUD (session: $SESSION_NAME)..."
    create_session "$cwd" "${codex_args[@]}"
    
    # Attach to the session
    tmux attach-session -t "$SESSION_NAME"
}

# Show help
show_help() {
    cat << EOF
codex-hud - Codex CLI with HUD display

Usage: codex-hud [options] [codex options...]

This wrapper launches Codex in a tmux session with a real-time status bar
showing model info, git status, project info, token usage, and more.

All arguments are passed through to the codex command.

Options:
  -h, --help          Show this help message
  --kill              Kill existing session for current directory
  --list              List all codex-hud sessions

Environment Variables:
  CODEX_HUD_POSITION  HUD pane position: bottom (default), top
  CODEX_HUD_HEIGHT    HUD pane height in lines (default: 3)
  CODEX_HUD_NO_ATTACH If set, always create new session

Requirements:
  - tmux (auto-installed if missing)
  - Node.js 18+
  - Codex CLI

Examples:
  codex-hud                    Start Codex with HUD
  codex-hud --model gpt-5      Start with specific model
  codex-hud "help me debug"    Start with initial prompt
  codex-hud --kill             Kill existing session
  CODEX_HUD_POSITION=top codex-hud  HUD on top

For more information, see: https://github.com/openai/codex
EOF
}

# Kill existing session
kill_session() {
    if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
        tmux kill-session -t "$SESSION_NAME"
        info "Session '$SESSION_NAME' killed."
    else
        warn "No session found: $SESSION_NAME"
    fi
}

# List all codex-hud sessions
list_sessions() {
    echo "Active codex-hud sessions:"
    tmux list-sessions 2>/dev/null | grep "^codex-hud-" || echo "  (none)"
}

# Check for special flags first
case "${1:-}" in
    -h|--help)
        show_help
        exit 0
        ;;
    --kill)
        # Need to check dependencies to ensure tmux is available
        if command_exists tmux; then
            kill_session
        else
            error "tmux not installed"
        fi
        exit 0
        ;;
    --list)
        if command_exists tmux; then
            list_sessions
        else
            error "tmux not installed"
        fi
        exit 0
        ;;
esac

# Run main
main "$@"
